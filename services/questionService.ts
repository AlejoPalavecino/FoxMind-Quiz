import { type Question, Area } from '../types';
import { TOTAL_QUESTIONS } from '../constants';

// üßÆ CONTENIDO ‚Äî üîß EDITABLE: Este es el banco de preguntas del quiz.
// üõ†Ô∏è C√ìMO CAMBIAR:
// 1. Agrega o elimina objetos de pregunta en este array.
// 2. Mant√©n la estructura: { id, area, prompt, options, correctIndex, explanation }.
// 3. `options` debe tener siempre 4 elementos.
// 4. `correctIndex` es la posici√≥n de la respuesta correcta (0, 1, 2, o 3).
// 5. Aseg√∫rate de tener suficientes preguntas (al menos 1 por √°rea, idealmente m√°s de 24 en total para variedad).
const questions: Question[] = [
    // Matem√°tica
    { id: 1, area: Area.Matematica, prompt: "48 √∑ 6 = ?", options: ["6", "7", "8", "9"], correctIndex: 2, explanation: "6 por 8 es 48." },
    { id: 2, area: Area.Matematica, prompt: "37 + 28 = ?", options: ["55", "65", "64", "66"], correctIndex: 1, explanation: "30+20=50, 7+8=15. 50+15=65." },
    { id: 3, area: Area.Matematica, prompt: "Per√≠metro de un rect√°ngulo de lados 8 y 5:", options: ["13", "26", "40", "16"], correctIndex: 1, explanation: "El per√≠metro es 2 * (largo + ancho), entonces 2 * (8 + 5) = 26." },
    { id: 4, area: Area.Matematica, prompt: "15 √ó 7 = ?", options: ["95", "85", "90", "105"], correctIndex: 3, explanation: "10*7=70, 5*7=35. 70+35=105." },
    { id: 5, area: Area.Matematica, prompt: "√Årea de un tri√°ngulo (base 10, altura 6):", options: ["60", "30", "16", "32"], correctIndex: 1, explanation: "El √°rea es (base * altura) / 2, entonces (10 * 6) / 2 = 30." },
    { id: 6, area: Area.Matematica, prompt: "96 - 57 = ?", options: ["49", "39", "41", "29"], correctIndex: 1, explanation: "96 - 50 = 46. 46 - 7 = 39." },
    // Lengua
    { id: 7, area: Area.Lengua, prompt: "¬øCu√°l oraci√≥n est√° bien puntuada?", options: ["‚ÄúCu√°ndo vienes?‚Äù", "‚Äú¬øCu√°ndo vienes?‚Äù", "‚Äú¬øCu√°ndo vienes?.‚Äù", "‚ÄúCu√°ndo, vienes?‚Äù"], correctIndex: 1, explanation: "Las preguntas en espa√±ol deben llevar signos de interrogaci√≥n al principio y al final." },
    { id: 8, area: Area.Lengua, prompt: "Sujeto en: ‚ÄúAyer, en la escuela, explic√≥ el profesor las reglas.‚Äù", options: ["Ayer", "la escuela", "el profesor", "las reglas"], correctIndex: 2, explanation: "El sujeto es quien realiza la acci√≥n del verbo 'explic√≥'." },
    { id: 9, area: Area.Lengua, prompt: "Sin√≥nimo de ‚Äúconciso‚Äù:", options: ["largo", "detallado", "breve", "complicado"], correctIndex: 2, explanation: "Conciso significa que expresa mucho con pocas palabras." },
    { id: 10, area: Area.Lengua, prompt: "Funci√≥n de ‚Äúcon atenci√≥n‚Äù en ‚ÄúLe√≠ el informe con atenci√≥n‚Äù:", options: ["Objeto Directo", "Sujeto", "Modificador Circunstancial", "Predicado"], correctIndex: 2, explanation: "Indica el modo en que se realiz√≥ la acci√≥n." },
    { id: 11, area: Area.Lengua, prompt: "¬øQu√© palabra lleva tilde por ser esdr√∫jula?", options: ["dialogo", "dialog√≥", "di√°logo", "dialogar"], correctIndex: 2, explanation: "Las palabras esdr√∫julas siempre llevan tilde en la antepen√∫ltima s√≠laba." },
    { id: 12, area: Area.Lengua, prompt: "La palabra ‚Äúplausible‚Äù significa:", options: ["aplaudible", "veros√≠mil", "complicado", "sencillo"], correctIndex: 1, explanation: "Algo plausible es algo que parece cre√≠ble o admisible." },
    // Ciencias Naturales
    { id: 13, area: Area.CsNaturales, prompt: "Funci√≥n principal de los alv√©olos pulmonares:", options: ["Filtrar aire", "Producir moco", "Intercambio gaseoso", "Calentar el aire"], correctIndex: 2, explanation: "En los alv√©olos, el ox√≠geno pasa a la sangre y el di√≥xido de carbono sale de ella." },
    { id: 14, area: Area.CsNaturales, prompt: "Ejemplo de una planta gimnosperma:", options: ["manzano", "rosa", "pino", "helecho"], correctIndex: 2, explanation: "Las gimnospermas, como los pinos, tienen semillas desnudas (no en un fruto)." },
    { id: 15, area: Area.CsNaturales, prompt: "¬øQu√© sistema corporal coordina respuestas r√°pidas a est√≠mulos?", options: ["Sistema endocrino", "Sistema nervioso", "Sistema circulatorio", "Sistema digestivo"], correctIndex: 1, explanation: "El sistema nervioso utiliza impulsos el√©ctricos para respuestas casi instant√°neas." },
    { id: 16, area: Area.CsNaturales, prompt: "Vitamina que la piel sintetiza con la exposici√≥n al sol:", options: ["Vitamina A", "Vitamina C", "Vitamina D", "Vitamina K"], correctIndex: 2, explanation: "La vitamina D es crucial para la absorci√≥n de calcio." },
    { id: 17, area: Area.CsNaturales, prompt: "¬øCu√°l de estos es un recurso natural no renovable?", options: ["Energ√≠a solar", "Viento", "Madera", "Petr√≥leo"], correctIndex: 3, explanation: "El petr√≥leo se form√≥ durante millones de a√±os y sus reservas son finitas." },
    { id: 18, area: Area.CsNaturales, prompt: "Principal √≥rgano encargado de filtrar la sangre:", options: ["H√≠gado", "Pulmones", "Ri√±ones", "Est√≥mago"], correctIndex: 2, explanation: "Los ri√±ones eliminan desechos y exceso de l√≠quido de la sangre para producir orina." },
    // Ciencias Sociales (Argentina)
    { id: 19, area: Area.CsSociales, prompt: "¬øEn qu√© a√±o ocurri√≥ la Revoluci√≥n de Mayo?", options: ["1816", "1810", "1853", "1910"], correctIndex: 1, explanation: "El 25 de mayo de 1810 se form√≥ el Primer Gobierno Patrio." },
    { id: 20, area: Area.CsSociales, prompt: "Grupo inmigrante m√°s numeroso en Argentina (fines s. XIX-ppios s. XX):", options: ["espa√±ola", "alemana", "italiana", "polaca"], correctIndex: 2, explanation: "La gran inmigraci√≥n italiana dej√≥ una profunda huella cultural en el pa√≠s." },
    { id: 21, area: Area.CsSociales, prompt: "Jos√© de San Mart√≠n es conocido como el Libertador de:", options: ["Argentina", "Argentina y Chile", "Argentina, Chile y Per√∫", "Sudam√©rica"], correctIndex: 2, explanation: "Su campa√±a militar fue crucial para la independencia de estos tres pa√≠ses." },
    { id: 22, area: Area.CsSociales, prompt: "La Constituci√≥n Nacional Argentina fue sancionada en:", options: ["1810", "1816", "1853", "1983"], correctIndex: 2, explanation: "La Constituci√≥n de 1853 sent√≥ las bases de la organizaci√≥n del estado argentino." },
    { id: 23, area: Area.CsSociales, prompt: "La Ley S√°enz Pe√±a de 1912 estableci√≥:", options: ["El fin de la esclavitud", "La educaci√≥n gratuita", "El voto secreto y obligatorio para hombres", "El voto femenino"], correctIndex: 2, explanation: "Esta ley fue un hito en la ampliaci√≥n de la democracia en Argentina." },
    { id: 24, area: Area.CsSociales, prompt: "El 9 de Julio se conmemora la:", options: ["Revoluci√≥n de Mayo", "Declaraci√≥n de la Independencia", "Batalla de San Lorenzo", "Fundaci√≥n de Buenos Aires"], correctIndex: 1, explanation: "El 9 de julio de 1816 se declar√≥ la independencia de las Provincias Unidas del R√≠o de la Plata." },
    // --- Nuevas preguntas ---
    // Matem√°tica
    { id: 25, area: Area.Matematica, prompt: "72 √∑ 8 = ¬ø?", options: ["6", "8", "9", "12"], correctIndex: 2, explanation: "72 dividido 8 es 9." },
    { id: 26, area: Area.Matematica, prompt: "¬øCu√°l es el 25% de 240?", options: ["40", "50", "60", "80"], correctIndex: 2, explanation: "El 25% es 1/4: 240 √∑ 4 = 60." },
    { id: 27, area: Area.Matematica, prompt: "Per√≠metro de un tri√°ngulo equil√°tero de lado 7", options: ["14", "21", "28", "49"], correctIndex: 1, explanation: "Per√≠metro = 3 √ó 7 = 21." },
    { id: 28, area: Area.Matematica, prompt: "(12 ‚àí 4) √ó 3 + 6 =", options: ["18", "24", "30", "36"], correctIndex: 2, explanation: "Primero par√©ntesis: 8 √ó 3 = 24; 24 + 6 = 30." },
    // Lengua
    { id: 29, area: Area.Lengua, prompt: "¬øCu√°l de las siguientes es una oraci√≥n bimembre?", options: ["Lluvia todo el d√≠a.", "¬°Qu√© fr√≠o!", "La maestra explic√≥ el tema.", "Silencio en clase."], correctIndex: 2, explanation: "‚ÄúLa maestra explic√≥ el tema‚Äù tiene sujeto y predicado (bimembre)." },
    { id: 30, area: Area.Lengua, prompt: "Eleg√≠ la forma correcta:", options: ["Porque llegaste tarde?", "¬øPorqu√© llegaste tarde?", "¬øPor qu√© llegaste tarde?", "¬øPor que llegaste tarde?"], correctIndex: 2, explanation: "Interrogativa directa: ‚Äú¬øPor qu√©‚Ä¶?‚Äù separado y con tilde en ‚Äúqu√©‚Äù." },
    { id: 31, area: Area.Lengua, prompt: "En ‚ÄúEl libro que compr√© es interesante‚Äù, ‚Äúque‚Äù funciona como‚Ä¶", options: ["conjunci√≥n copulativa", "pronombre relativo", "art√≠culo determinado", "preposici√≥n"], correctIndex: 1, explanation: "‚Äúque‚Äù introduce una subordinada adjetiva: pronombre relativo." },
    { id: 32, area: Area.Lengua, prompt: "Complet√°: ‚ÄúNo vino a la reuni√≥n; ___, envi√≥ su informe por correo.‚Äù", options: ["sin embargo", "por lo tanto", "adem√°s", "aunque"], correctIndex: 0, explanation: "Contrasta la ausencia con el env√≠o del informe: ‚Äúsin embargo‚Äù." },
    // Ciencias Naturales
    { id: 33, area: Area.CsNaturales, prompt: "En la fotos√≠ntesis, la planta consume principalmente‚Ä¶", options: ["ox√≠geno", "nitr√≥geno", "di√≥xido de carbono", "hidr√≥geno"], correctIndex: 2, explanation: "Usa CO‚ÇÇ y libera ox√≠geno." },
    { id: 34, area: Area.CsNaturales, prompt: "¬øQu√© org√°nulo celular produce mayormente la energ√≠a?", options: ["n√∫cleo", "aparato de Golgi", "mitocondria", "lisosoma"], correctIndex: 2, explanation: "La mitocondria realiza la respiraci√≥n celular y produce ATP." },
    { id: 35, area: Area.CsNaturales, prompt: "La sublimaci√≥n es el cambio de estado de‚Ä¶", options: ["s√≥lido a l√≠quido", "l√≠quido a gas", "s√≥lido a gas", "gas a l√≠quido"], correctIndex: 2, explanation: "S√≥lido ‚Üí gas (p.ej., hielo seco)." },
    { id: 36, area: Area.CsNaturales, prompt: "Tejido que transporta savia elaborada en plantas", options: ["xilema", "floema", "c√°mbium", "periderma"], correctIndex: 1, explanation: "El floema lleva az√∫cares desde las hojas al resto de la planta." },
    // Ciencias Sociales (Argentina)
    { id: 37, area: Area.CsSociales, prompt: "¬øEn qu√© a√±o comenz√≥ la presidencia de Domingo F. Sarmiento?", options: ["1816", "1853", "1868", "1912"], correctIndex: 2, explanation: "Sarmiento gobern√≥ 1868‚Äì1874." },
    { id: 38, area: Area.CsSociales, prompt: "La Guerra de la Triple Alianza (1864‚Äì1870) enfrent√≥ a la alianza contra‚Ä¶", options: ["Chile", "Paraguay", "Per√∫", "Bolivia"], correctIndex: 1, explanation: "Argentina, Brasil y Uruguay lucharon contra Paraguay." },
    { id: 39, area: Area.CsSociales, prompt: "La Ley S√°enz Pe√±a (1912) estableci√≥‚Ä¶", options: ["sufragio femenino obligatorio", "voto secreto, universal (masculino) y obligatorio", "voto cantado y voluntario", "elecciones indirectas"], correctIndex: 1, explanation: "Introdujo el voto secreto, universal masculino y obligatorio." },
    { id: 40, area: Area.CsSociales, prompt: "¬øQui√©n escribi√≥ la letra del Himno Nacional Argentino?", options: ["Jos√© de San Mart√≠n", "Vicente L√≥pez y Planes", "Bartolom√© Mitre", "Domingo F. Sarmiento"], correctIndex: 1, explanation: "Letra: Vicente L√≥pez y Planes; m√∫sica: Blas Parera." }
];

const RECENT_IDS_KEY = 'foxmind_quiz_recent_ids';
const RECENT_IDS_MAX = 12; // Guarda las √∫ltimas 12 preguntas para evitar repetirlas.

const getRecentIds = (): number[] => {
    try {
        return JSON.parse(localStorage.getItem(RECENT_IDS_KEY) || '[]');
    } catch {
        return [];
    }
};

export const pushRecentIds = (newIds: number[]): void => {
    try {
        const prevIds = getRecentIds();
        const nextIds = [...newIds, ...prevIds].slice(0, RECENT_IDS_MAX);
        localStorage.setItem(RECENT_IDS_KEY, JSON.stringify(nextIds));
    } catch (error) {
        console.error("Failed to save recent question IDs", error);
    }
};

/**
 * Baraja un array en su lugar utilizando el algoritmo Fisher-Yates.
 * @param array El array a barajar.
 * @returns El mismo array, pero barajado.
 */
function shuffle<T,>(array: T[]): T[] {
  let currentIndex = array.length, randomIndex;
  while (currentIndex !== 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

/**
 * Selecciona un conjunto de preguntas para una nueva partida de quiz.
 * Garantiza una distribuci√≥n equilibrada de √°reas tem√°ticas y evita repetir preguntas recientes.
 * üîß EDITABLE: Puedes cambiar la l√≥gica de selecci√≥n para, por ejemplo,
 * tener m√°s preguntas de un √°rea espec√≠fica o hacerla completamente aleatoria.
 * @returns {Question[]} Un array de preguntas barajadas para la partida.
 */
export const getQuizQuestions = (): Question[] => {
    const recentIds = new Set(getRecentIds());
    
    // Clasifica todas las preguntas por √°rea.
    const questionsByArea = {
        [Area.Matematica]: [] as Question[],
        [Area.Lengua]: [] as Question[],
        [Area.CsNaturales]: [] as Question[],
        [Area.CsSociales]: [] as Question[],
    };
    questions.forEach(q => {
        questionsByArea[q.area].push(q);
    });

    // Helper para elegir una pregunta, evitando recientes si es posible.
    const pickOne = (questionList: Question[]): Question | undefined => {
        const nonRecentPool = questionList.filter(q => !recentIds.has(q.id));
        const pool = nonRecentPool.length > 0 ? nonRecentPool : questionList;
        if (pool.length === 0) return undefined;
        return pool[Math.floor(Math.random() * pool.length)];
    };
    
    const selectedQuestions: Question[] = [];
    const usedIds = new Set<number>();

    // 1. Obtiene una pregunta garantizada de cada √°rea.
    (Object.keys(questionsByArea) as Area[]).forEach(area => {
        const question = pickOne(questionsByArea[area]);
        if (question && !usedIds.has(question.id)) {
            selectedQuestions.push(question);
            usedIds.add(question.id);
        }
    });

    // 2. Rellena las preguntas restantes con una selecci√≥n aleatoria de las no utilizadas.
    const remainingPool = questions.filter(q => !usedIds.has(q.id));
    
    while (selectedQuestions.length < TOTAL_QUESTIONS && remainingPool.length > 0) {
        const nonRecentRemaining = remainingPool.filter(q => !recentIds.has(q.id));
        const poolToPickFrom = nonRecentRemaining.length > 0 ? nonRecentRemaining : remainingPool;

        const pick = poolToPickFrom[Math.floor(Math.random() * poolToPickFrom.length)];
        
        selectedQuestions.push(pick);
        usedIds.add(pick.id);

        const indexToRemove = remainingPool.findIndex(q => q.id === pick.id);
        if (indexToRemove > -1) {
            remainingPool.splice(indexToRemove, 1);
        }
    }
    
    // Baraja el conjunto final para que no aparezcan siempre en el mismo orden de √°rea.
    return shuffle(selectedQuestions);
};